<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ - Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* General Styles for RTL and Font */
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background-color: #f0f4f8; 
            transition: all 0.3s ease; 
            min-height: 100vh;
        }
        
        /* Fixed Navigation Bar Styling */
        #navigation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            padding: 1rem 0 0 0;
            background-color: transparent;
        }
        #app {
            width: 100%;
            padding-top: 6rem; 
        }

        /* --- Teacher View Original Styles (Card View) --- */
        body:not(.admin-mode) #app {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 6rem); 
            padding-top: 2rem; 
            padding-bottom: 2rem;
        }
        .teacher-card-style {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            width: 85%;
            max-width: 400px;
            text-align: center;
            border-top: 6px solid #ff9800;
        }
        .teacher-logo-style {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-color: white;
        }
        .teacher-logo-style img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }
        .teacher-h2-style {
            color: #2d3436;
            margin: 10px 0 5px;
            font-size: 22px;
            font-weight: 700;
        }
        .teacher-p-style {
            color: #636e72;
            font-size: 14px;
            margin-bottom: 25px;
        }

        /* Button group for select view */
        .btn-group-select {
            display: flex;
            gap: 12px;
        }
        .btn-in { background-color: #27ae60; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); }
        .btn-out { background-color: #e74c3c; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3); }
        .btn-select-style {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            color: white;
        }


        /* Select and Button Overrides */
        select { transition: all 0.3s ease; text-align: right; }
        button:active { transform: scale(0.96); }

        /* Input Field Base (used by both views) */
        .input-field { border: 2px solid #dfe6e9; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .input-field:focus { border-color: #ff9800; background-color: #fff; outline: none; }

        /* Specific select style for teacher view */
        .input-field.teacher-select-style {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            font-size: 15px;
            background-color: #fafafa;
            border: 2px solid #dfe6e9;
        }
        
        /* UPDATED: Extra small custom footer style */
        .tiny-footer {
            margin-top: 1.5rem; 
            font-size: 9px; 
            opacity: 0.6; 
            letter-spacing: 0.5px;
            font-weight: 500;
            text-align: center;
        }


        /* Admin Mode Styles (Keeping these intact) */
        body.admin-mode { background-color: #1e293b; color: #f1f5f9; }
        .admin-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .admin-mode .input-field { background-color: #1e293b; border-color: #334155; color: white; }
        .admin-mode .input-field:focus { border-color: #ff9800; box-shadow: 0 0 15px rgba(255, 152, 0, 0.3); }
        .admin-mode .bg-white { background-color: #334155 !important; }
        .admin-mode .text-gray-800 { color: #f1f5f9 !important; }
        .admin-mode .text-gray-600 { color: #cbd5e1 !important; }

        /* Report Table Styles */
        .report-table th { background-color: #f9fafb; color: #1f2937; }
        .admin-mode .report-table th { background-color: #475569; color: #f1f5f9; }
        .report-table td, .report-table th { padding: 12px; border: 1px solid #e5e7eb; }
        .report-table { border-collapse: collapse; }
        .admin-mode .report-table td, .admin-mode .report-table th { border-color: #475569; }
        
        /* Time Column Specific Styling */
        .time-entry { color: #27ae60; font-weight: bold; }
        .time-exit { color: #e74c3c; font-weight: bold; }

        /* Helper for Loading */
        #loadingOverlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen">

    <script>
        // âš ï¸ Ù„ÛŒÙ†Ú©ÛŒ Web App Û• Ù†ÙˆÛÛŒÛ•Ú©Û•Øª Ù„ÛØ±Û• Ø¯Ø§Ø¨Ù†Û.
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwq_J4VSLm2PH_fD_Hdc3B0OLO4S4T8advLXC-G2kgCVHH1V7EEpwG5sN0XBoYRhfhT/exec"; // Ú¯Û†Ú•ÛŒÙ†ÛŒ Ø¨Û• Ù„ÛŒÙ†Ú©Û•Ú©Û•ÛŒ Ø®Û†Øª
        
        // Ú¯Û†Ú•Ø§ÙˆÛ• Ø¬ÛŒÙ‡Ø§Ù†ÛŒÛŒÛ•Ú©Ø§Ù†
        let state = {
            currentView: 'teacher', 
            isAdminAuthenticated: false,
            teachers: [
                "Ø¯ÛŒØ¯Û•Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ø³Ù…Ø§Ø¹ÛŒÙ„ Ø¨ÛŒØ±ÙˆØª", "Ø­Ú©ÛŒÙ… Ø­Ù…Ø¯ Ø±Ø³ÙˆÙ„ Ø¹Ø¨Ø¯Ø§Ù„Ù„Û•", "Ø³Ø§Ø±ÛÚ˜ Ø®Ø¶Ø± Ø­Ù…Ø¯ Ø±Ø³ÙˆÙ„", 
                "Ú©Ø§Ù†ÛŒØ§Ùˆ Ù†Ø§ØµØ± Ø­Ø³Ù† Ø§Ø­Ù…Ø¯", "Ø¨Û•Ù‡Ø§Ø± Ø­Ù…Ø¯Ø§Ù…ÛŒÙ† Ø±Ø­Ù…Ù† Ø§Ø¨ÙˆØ¨Ú©Ø±", "Ù…ÛŒÙ‡Ù†Ø§Ø² Ø¹Ù…Ø± Ø§Ø¨Ø±Ø§Ù‡ÛŒÙ… Ø¹Ø¨Ø¯Ø§Ù„Ù„Û•", 
                "Ø§Ø³Ù…Ø± Ù„Ù‚Ù…Ø§Ù† Ø§Ø­Ù…Ø¯ Ù‚Ø§Ø¯Ø±", "Ø³Û•ÙÛŒÙ† Ù…Ø­Ù…Ø¯Ø§Ù…ÛŒÙ† Ø¹Ø«Ù…Ø§Ù† Ø­Ù…Ø¯", "Ø¨Û•Ù‡ÛØ² Ù‚Ø§Ø¯Ø± Ù…ØµØ·ÙÛŒ Ø¹Ø¨Ø¯Ø§Ù„Ù‚Ø§Ø¯Ø±", 
                "Ø²Ø§Ù†ÛŒØ§Ø± Ù…ØºØ¯ÛŒØ¯ Ù…Ø­Ù…Ø¯ Ø±Ø³ÙˆÙ„", "Ø³Û†Ù†ÛŒØ§ ÙØ±ÛŒØ§Ø¯ Ø¹Ø²ÛŒØ² Ù…ØµØ·ÙÛŒ", "Ø¦Ø§Ø´ØªÛŒ Ù…Ø­Ø³ÛŒÙ† Ø³Ø¹ÛŒØ¯ ØµÙˆÙÛŒ", 
                "Ù†ÛŒØ§Ø² Ø­Ø³Ù† Ø­Ø³ÛŒÙ† Ø­Ù…Û•Ø³ÙˆØ±", "Ù†Û•Ø±Ù…ÛŒÙ† ÙØ§Ø±Ø³ Ø§Ø³Ù…Ø§Ø¹ÛŒÙ„ Ø¹Ù„ÛŒ", "Ú©Ø§Ø±ÙˆØ§Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ø³Ù…Ø§Ø¹ÛŒÙ„ Ø¨ÛŒØ±ÙˆØª", 
                "Ø¯ÛŒÙ„Ø§Ù† Ø·Ø§Ù„Ø¨ Ø¨ÛŒØ±ÙˆØª Ù…Ø­Ù…ÙˆØ¯", "Ø¨Û•Ù‡Ø±Û• Ø§Ø­Ù…Ø¯ Ù‚Ø§Ø¯Ø± Ù…Ø­Ù…Ø¯Ø§Ù…ÛŒÙ†", "Ú†Ø±Û† Ù…Ø±Ø´Ø¯ Ù…ØµØ·ÙÙ‰ Ø¹Ø²ÛŒØ²", 
                "Ù…Û•Ø³ØªØ§Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Û• Ù‚Ø§Ø¯Ø± Ø§ÙˆØ±Ø­Ù…Ø§Ù†", "Ù…Ø­Ù…Ø¯ Ø§ÛŒÙˆØ¨ Ø±Ø³ÙˆÙ„ Ù…ØµØ·ÙÛŒ", "Ù†ÛŒÚ¯Ø§Ø± Ø§Ø³ÙˆØ¯ Ø§Ø­Ù…Ø¯ Ø­Ù…Ø¯", 
                "Ú©Ø§Ø±Ø§ Ù‡Ù…Ø¯Ø§Ø¯ Ø±ÙÛŒÙ‚ Ø³Ø¹ÛŒØ¯", "Ø´Ø§Ù‡Û†Ø² Ø§Ø¨Ø±Ø§Ù‡ÛŒÙ… Ø§Ø­Ù…Ø¯ Ù†Ø¨ÛŒ", "Ø¦ÛØ±Ø§Ù† Ø´ÛØ®Û• Ù‚Ø§Ø¯Ø± Ø±Ø³ÙˆÙ„"
            ],
            attendanceData: [], 
            login: { username: '', password: '' },
            report: {
                period: 'daily', 
                date: new Date().toISOString().split('T')[0] // today's date YYYY-MM-DD
            },
            teacherName: ''
        };

        const TEACHERS_LIST = state.teachers.map(name => `<option value="${name}">${name}</option>`).join('');

        // --- Utility Functions ---

        // Ø¨Û† Ú¯Û†Ú•ÛŒÙ†ÛŒ Ø¯Ø§ØªØ§ÛŒ Ù…ÛØªØ§ Ùˆ Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ ÙØ§ÛŒÙ„ÛŒ Excel (CSV)
        function convertToCSV(data) {
            // Ø³Û•Ø± Ø³ØªÙˆÙˆÙ†Û•Ú©Ø§Ù†
            const header = ["Ù†Ø§ÙˆÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§", "Ø¨Û•Ø±ÙˆØ§Ø±", "Ú•Û†Ú˜", "Ú©Ø§ØªÛŒ Ù‡Ø§ØªÙ†", "Ú©Ø§ØªÛŒ Ú•Û†ÛŒØ´ØªÙ†"];
            const rows = data.map(row => [
                row.teacherName,
                // Ú¯Û†Ú•ÛŒÙ†ÛŒ ÙÛ†Ø±Ù…Ø§ØªÛŒ MM/dd/yyyy Ø¨Û† Ø´ÛÙˆÛ•ÛŒ Ø¦Ø§Ø³Ø§Ù†ØªØ± Ø¨Û† Ø¨ÛŒÙ†ÛŒÙ†
                formatDateForDisplay(row.date),
                getKurdishDay(row.date),
                row.entryTime || 'Ù†Ø§Ø¯ÛŒØ§Ø±',
                row.exitTime || 'Ù†Ø§Ø¯ÛŒØ§Ø±' 
            ]);
            return [header, ...rows];
        }

        function downloadExcel(data, filename) {
            if (!Array.isArray(data) || data.length === 0) {
                alert("âš ï¸ Ù†Ø§ØªÙˆØ§Ù†ÛŒØª ÙØ§ÛŒÙ„Û•Ú©Û• Ø¯Ø§Ø¨Û•Ø²ÛÙ†ÛŒØª Ú†ÙˆÙ†Ú©Û• Ù‡ÛŒÚ† ØªÛ†Ù…Ø§Ø±ÛÚ© Ù†ÛŒÛŒÛ•.");
                return;
            }
            
            const ws = XLSX.utils.aoa_to_sheet(convertToCSV(data));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†");
            
            // Ú†Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù†Ø§ÙˆÛŒ ÙØ§ÛŒÙ„ Ø¨Û† Ø¯ÚµÙ†ÛŒØ§Ø¨ÙˆÙˆÙ†Û•ÙˆÛ• Ù„Û• Ù†Û•Ø¨ÙˆÙˆÙ†ÛŒ Ú©Ø§Ø±Û•Ú©ØªÛ•Ø±ÛŒ Ù†Ø§Ø¯Ø±ÙˆØ³Øª
            const safeFilename = filename.replace(/[^a-z0-9]/gi, '_'); 
            XLSX.writeFile(wb, safeFilename + ".xlsx");
        }

        // ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ú•Û†Ú˜ÛŒ Ù‡Û•ÙØªÛ• Ø¨Û• Ú©ÙˆØ±Ø¯ÛŒ
        function getKurdishDay(dateString) {
            let date;
            try {
                 if (dateString.includes('/')) {
                    // Assuming MM/dd/yyyy from GAS
                    const parts = dateString.split('/');
                    date = new Date(parts[2], parts[0] - 1, parts[1]);
                } else if (dateString.includes('-')) {
                    // Assuming YYYY-MM-DD from input[date]
                    const parts = dateString.split('-');
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    return "Ù†Ø§Ø¯ÛŒØ§Ø±";
                }

                if (isNaN(date.getTime())) return "Ù†Ø§Ø¯ÛŒØ§Ø±";
                const days = ["ÛŒÛ•Ú©Ø´Û•Ù…Ù…Û•", "Ø¯ÙˆÙˆØ´Û•Ù…Ù…Û•", "Ø³ÛØ´Û•Ù…Ù…Û•", "Ú†ÙˆØ§Ø±Ø´Û•Ù…Ù…Û•", "Ù¾ÛÙ†Ø¬Ø´Û•Ù…Ù…Û•", "Ù‡Û•ÛŒÙ†ÛŒ", "Ø´Û•Ù…Ù…Û•"];
                return days[date.getDay()];
            } catch (e) {
                return "Ù†Ø§Ø¯ÛŒØ§Ø±";
            }
        }
        
        // Date formatting helper for display (MM/dd/yyyy -> long date)
        function formatDateForDisplay(dateString) {
            try {
                // item date is MM/dd/yyyy, convert to ku-IQ long date
                const parts = dateString.split('/');
                const date = new Date(parts[2], parts[0] - 1, parts[1]);
                return date.toLocaleDateString('ku-IQ', { day: 'numeric', month: 'long', year: 'numeric' });
            } catch (e) {
                return dateString;
            }
        }

        // ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ú©Ø§Øª Ø¨Û• Ø®ÙˆÙ„Û•Ú© Ø¨Û† Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ú©Ø§ØªÛŒ Ú©Ø§Ø±
        function getTimeInMinutes(date) {
            return date.getHours() * 60 + date.getMinutes();
        }
        
        // --- API Functions ---

        async function loadAttendanceData() {
            if (state.currentView === 'teacher' && state.isAdminAuthenticated === false) return; 
            
            showLoading("ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ø¯Ø§ØªØ§ÛŒ Ù¾ÙˆØ®ØªÚ©Ø±Ø§ÙˆÛŒ Ú•Ø§Ù¾Û†Ø±Øª...");
            
            try {
                // GAS Ø¦ÛØ³ØªØ§ Ø¯Ø§ØªØ§ Ù¾ÙˆØ®Øª Ø¯Û•Ú©Ø§Øª
                const response = await fetch(`${WEB_APP_URL}?action=get`); 
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    state.attendanceData = data;
                } else {
                    state.attendanceData = [];
                }
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('loadingText').innerText = "Ú©ÛØ´Û• Ù„Û• ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ø¯Ø§ØªØ§ Ú•ÙˆÙˆÛŒØ¯Ø§.";
                setTimeout(hideLoading, 2000);
            } finally {
                hideLoading();
                render();
            }
        }

        async function submitData(teacherName, type) {
            var messageDiv = document.getElementById(`message-general`); 
            
            if (!teacherName || teacherName === '') {
                showMessage(messageDiv, "âš ï¸ ØªÚ©Ø§ÛŒÛ• Ø³Û•Ø±Û•ØªØ§ Ù†Ø§ÙˆÛŒ Ø®Û†Øª Ù„Û• Ù„ÛŒØ³ØªÛ•Ú©Û• Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•!", "error");
                return;
            }

            // --- âœ… Ú¯Û•Ú•Ø§Ù†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø³Ù†ÙˆÙˆØ±ÛŒ Ú©Ø§Øª (Time Gates) ---
            var now = new Date();
            var currentTime = getTimeInMinutes(now);
            const ENTRY_START = 7 * 60 + 30; // 07:30
            const ENTRY_END = 10 * 60;       // 10:00
            const EXIT_START = 10 * 60;      // 10:00
            const EXIT_END = 16 * 60;        // 16:00 (04:00 PM)

            if (type === 'Ù‡Ø§ØªÙ†') {
                if (currentTime < ENTRY_START || currentTime >= ENTRY_END) {
                    showMessage(messageDiv, "â›” Ù†Ø§ØªÙˆØ§Ù†ÛŒØª Ø¦ÛØ³ØªØ§ ØªÛ†Ù…Ø§Ø±ÛŒ Ù‡Ø§ØªÙ† Ø¨Ú©Û•ÛŒØª. Ú©Ø§ØªÛŒ ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ù‡Ø§ØªÙ†: 07:30 ØªØ§ 10:00 Ø¨Û•ÛŒØ§Ù†ÛŒ.", "error");
                    return;
                }
            } else if (type === 'Ú•Û†ÛŒØ´ØªÙ†') {
                if (currentTime < EXIT_START || currentTime >= EXIT_END) {
                    showMessage(messageDiv, "â›” Ù†Ø§ØªÙˆØ§Ù†ÛŒØª Ø¦ÛØ³ØªØ§ ØªÛ†Ù…Ø§Ø±ÛŒ Ú•Û†ÛŒØ´ØªÙ† Ø¨Ú©Û•ÛŒØª. Ú©Ø§ØªÛŒ ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ú•Û†ÛŒØ´ØªÙ†: 10:00 Ø¨Û•ÛŒØ§Ù†ÛŒ ØªØ§ 04:00 Ø¦ÛÙˆØ§Ø±Û•.", "error");
                    return;
                }
            }
            // --- Ú©Û†ØªØ§ÛŒÛŒ Ø³Ù†ÙˆÙˆØ±ÛŒ Ú©Ø§Øª ---
            
            showMessage(messageDiv, "â³ ...ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•Û Ø¨Û•", "pending");
            
            var formData = new FormData();
            formData.append("teacherName", teacherName);
            formData.append("type", type);

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    body: formData,
                });
                const data = await response.text();

                if (data.includes("SUCCESS")) {
                    const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                    const date = now.toLocaleDateString('ku-IQ');
                    
                    showMessage(messageDiv, `âœ… Ø¨Û•Ú•ÛØ² <b>${teacherName}</b><br>ØªÛ†Ù…Ø§Ø±ÛŒ <b>${type}</b> Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ.<br>Ú©Ø§Øª: ${time} - Ø¨Û•Ø±ÙˆØ§Ø±: ${date}`, "success");
                    
                    setTimeout(function() {
                        messageDiv.style.display = "none";
                        state.teacherName = '';
                        render();
                    }, 5000);
                } else {
                    showMessage(messageDiv, "âŒ Ú©ÛØ´Û• Ù„Û• ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù† Ú•ÙˆÙˆÛŒØ¯Ø§. Ø¯ÙˆÙˆØ¨Ø§Ø±Û• ØªØ§Ù‚ÛŒ Ø¨Ú©Û•Ø±Û•ÙˆÛ•.", "error");
                }
            } catch (error) {
                showMessage(messageDiv, "âŒ Ú©ÛØ´Û• Ù„Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ: " + error.message, "error");
            }
        }

        // --- UI Helper Functions (UNCHANGED) ---
        
        function showMessage(el, text, type) {
            el.style.display = "block";
            el.className = "";
            let baseStyle = "margin-top: 20px; padding: 12px; border-radius: 10px; font-size: 14px; text-align: right;";

            if (type === 'success') {
                el.className = "success";
                el.style.cssText = baseStyle + " background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;";
            } else if (type === 'error') {
                el.className = "error";
                el.style.cssText = baseStyle + " background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;";
            } else if (type === 'pending') {
                el.style.cssText = baseStyle + " background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;";
            }
            el.innerHTML = text;
        }

        function showLoading(text) {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = text;
            overlay.classList.remove('hidden', 'opacity-0');
            overlay.classList.add('opacity-100');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('opacity-100');
            overlay.classList.add('opacity-0');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
        }
        
        // --- Admin Logic ---

        async function handleLogin() {
            const { username, password } = state.login;
            
            if (!username || !password) {
                document.getElementById('loadingText').innerText = "ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ø±Ø¯ÙˆÙˆ Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± Ùˆ ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•.";
                showLoading("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ø±Ø¯ÙˆÙˆ Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± Ùˆ ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•.");
                setTimeout(hideLoading, 2000);
                return;
            }

            showLoading("Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•...");

            try {
                const formData = new FormData();
                formData.append("action", "login");
                formData.append("username", username);
                formData.append("password", password);

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.text();

                if (result.includes("SUCCESS")) { 
                    state.isAdminAuthenticated = true;
                    state.login = { username: '', password: '' };
                    await loadAttendanceData(); 
                    render();
                } else {
                    document.getElementById('loadingText').innerText = "Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± ÛŒØ§Ù† ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ•!";
                    setTimeout(hideLoading, 2000);
                }
            } catch (error) {
                document.getElementById('loadingText').innerText = "Ú©ÛØ´Û• Ù„Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨Û• Ø³ÛØ±Ú¤Û•Ø±. Ø¯ÙˆÙˆØ¨Ø§Ø±Û• ØªØ§Ù‚ÛŒ Ø¨Ú©Û•Ø±Û•ÙˆÛ•.";
                setTimeout(hideLoading, 2000);
            } finally {
                // hideLoading() only after showing the final status
                if (!state.isAdminAuthenticated) {
                     hideLoading();
                }
            }
        }
        
        function handleLogout() {
            state.isAdminAuthenticated = false;
            state.login = { username: '', password: '' };
            state.currentView = 'teacher';
            render();
        }

        // ğŸš¨ Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ú©Û†ØªØ§ÛŒÛŒ Ø¨Û† Ú©ÛØ´Û•ÛŒ Excel (filteredData) - Ú†Ø§Ú©Ú©Ø±Ø§Ùˆ
        function getFilteredData() {
            // Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ Ù‡Û•ÚµØ¨Ú˜ÛØ±Ø¯Ø±Ø§Ùˆ Ø¨Û• Ø´ÛÙˆØ§Ø²ÛŒ YYYY-MM-DD
            const selectedDateStr = state.report.date; 
            
            let startDate, endDate;
            let filtered = [];

            if (state.report.period === 'daily') {
                // Ø¨Û† daily: Ú¯Û†Ú•ÛŒÙ†ÛŒ YYYY-MM-DD Ø¨Û† MM/dd/yyyy Ø¨Û† Ø¨Û•Ø±Ø§ÙˆØ±Ø¯Ú©Ø±Ø¯Ù† Ù„Û•Ú¯Û•Úµ Ø¯Ø§ØªØ§ÛŒ GAS
                const parts = selectedDateStr.split('-'); 
                const formattedDate = `${parts[1]}/${parts[2]}/${parts[0]}`; 
                
                filtered = state.attendanceData.filter(item => item.date === formattedDate);
                
            } else if (state.report.period === 'weekly') {
                // Ø¨Û† weekly: Ø¯Û†Ø²ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¯Û•Ø³ØªÙ¾ÛÚ© Ùˆ Ú©Û†ØªØ§ÛŒÛŒ Ù‡Û•ÙØªÛ•
                const today = new Date(selectedDateStr);
                const dayOfWeek = today.getDay(); // 0 (Sun) to 6 (Sat)
                const daysToSubtract = (dayOfWeek + 1) % 7; // Ø¯Û•Ø³ØªÙ¾ÛÚ©ÛŒ Ù‡Û•ÙØªÛ• ÛŒÛ•Ú©Ø´Û•Ù…Ù…Û• Ø¨ÛØª

                startDate = new Date(today);
                startDate.setDate(today.getDate() - daysToSubtract);
                startDate.setHours(0, 0, 0, 0);

                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23, 59, 59, 999);
                
            } else if (state.report.period === 'monthly') {
                // Ø¨Û† monthly: Ø¯Û†Ø²ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¯Û•Ø³ØªÙ¾ÛÚ© Ùˆ Ú©Û†ØªØ§ÛŒÛŒ Ù…Ø§Ù†Ú¯
                const year = parseInt(selectedDateStr.split('-')[0]);
                const month = parseInt(selectedDateStr.split('-')[1]) - 1; 
                
                startDate = new Date(year, month, 1);
                endDate = new Date(year, month + 1, 0); 
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);
            }

            // Filter for weekly/monthly
            if (state.report.period !== 'daily') {
                 filtered = state.attendanceData.filter(item => {
                    let itemDate;
                    try {
                        // Item date is MM/dd/yyyy from GAS
                        const dateParts = item.date.split('/');
                        itemDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                        itemDate.setHours(0, 0, 0, 0); 
                    } catch(e) {
                        return false;
                    }

                    if (isNaN(itemDate.getTime())) return false;
                    return itemDate >= startDate && itemDate <= endDate;
                });
            }
            
            // Ø¯ÚµÙ†ÛŒØ§Ø¨ÙˆÙˆÙ†Û•ÙˆÛ• Ù„Û• Ú•ÛŒØ²Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø±ÙˆØ³Øª
            return filtered.sort((a, b) => {
                // Ú¯Û†Ú•ÛŒÙ†ÛŒ Ø¨Û•Ø±ÙˆØ§Ø±Û•Ú©Ø§Ù† Ø¨Û† Ø¦Û†Ø¨Ø¬ÛÚ©ØªÛŒ Date Ø¨Û† Ø¨Û•Ø±Ø§ÙˆØ±Ø¯Ú©Ø±Ø¯Ù† 
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);

                if (dateA - dateB !== 0) {
                    return dateB - dateA; // Ú•ÛŒØ²Ú©Ø±Ø¯Ù† Ø¨Û•Ù¾ÛÛŒ Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ Ù†ÙˆÛ
                }
                
                // Ø¦Û•Ú¯Û•Ø± Ø¨Û•Ø±ÙˆØ§Ø±Û•Ú©Ø§Ù† ÛŒÛ•Ú©Ø³Ø§Ù† Ø¨Ù†ØŒ Ú•ÛŒØ²Ú©Ø±Ø¯Ù† Ø¨Û•Ù¾ÛÛŒ Ú©Ø§ØªÛŒ Ù‡Ø§ØªÙ†
                const timeA = new Date(`2000/01/01 ${a.entryTime}`);
                const timeB = new Date(`2000/01/01 ${b.entryTime}`);
                return timeA - timeB; // Ú©Ø§ØªÛŒ Ù‡Ø§ØªÙ†ÛŒ Ù¾ÛØ´ØªØ±
            });
        }
        
        // --- Render Functions (Admin View Updated for summarized data) ---

        function renderTeacherView() {
            return `
            <div class="teacher-card-style" id="teacher-view">
                <div class="teacher-logo-style">
                    <img src="https://i.ibb.co/7xTBmQJ8/logo-gzng.png" alt="Logo Gzing">
                </div>
                
                <h2 class="teacher-h2-style">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ø¨Ù†Û•Ú•Û•ØªÛŒ Ú¯Ø²Ù†Ú¯</h2>
                <p class="teacher-p-style">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</p>

                <select id="teacherName" onchange="state.teacherName = this.value" value="${state.teacherName}" class="input-field teacher-select-style">
                    <option value="" disabled ${state.teacherName === '' ? 'selected' : ''}>ğŸ”½ ØªÚ©Ø§ÛŒÛ• Ù†Ø§ÙˆÛ•Ú©Û•Øª Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>
                    ${TEACHERS_LIST}
                </select>

                <div class="btn-group-select">
                    <button type="button" class="btn-select-style btn-in" onclick="submitData(state.teacherName, 'Ù‡Ø§ØªÙ†')">ğŸŸ¢ Ù‡Ø§ØªÙ†</button>
                    <button type="button" class="btn-select-style btn-out" onclick="submitData(state.teacherName, 'Ú•Û†ÛŒØ´ØªÙ†')">ğŸ”´ Ú•Û†ÛŒØ´ØªÙ†</button>
                </div>

                <div id="message-general" style="display:none;"></div>
                
                <div class="tiny-footer text-gray-500 mt-6">Developed by Tahir Tahir</div>
            </div>`;
        }

        function renderAdminLogin() {
            return `
            <div class="admin-card max-w-sm mx-auto p-8 rounded-3xl text-center my-20">
                <h2 class="text-3xl font-black text-white mb-6">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†</h2>
                <div class="space-y-4">
                    <input type="text" id="username" placeholder="Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±" oninput="state.login.username = this.value" value="${state.login.username}" class="input-field w-full rounded-xl px-5 py-3 text-center font-bold text-lg">
                    <input type="password" id="password" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ" oninput="state.login.password = this.value" value="${state.login.password}" class="input-field w-full rounded-xl px-5 py-3 text-center font-bold text-lg">
                    <button onclick="handleLogin()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-black py-3 rounded-xl transition duration-300 shadow-lg shadow-yellow-500/30 text-lg mt-4">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
                </div>
            </div>`;
        }
        
        function renderAdminView() {
            const filteredData = getFilteredData();
            let titleText = '';
            
            if (state.report.period === 'daily') {
                // Format the report date from YYYY-MM-DD
                const parts = state.report.date.split('-'); 
                const dateDisplay = formatDateForDisplay(`${parts[1]}/${parts[2]}/${parts[0]}`); 
                titleText = `Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú•Û†Ú˜Ø§Ù†Û• Ø¨Û†: ${dateDisplay}`;
            } else if (state.report.period === 'weekly') {
                const today = new Date(state.report.date);
                const dayOfWeek = today.getDay(); 
                const daysToSubtract = (dayOfWeek + 1) % 7; 
                let start = new Date(today);
                start.setDate(today.getDate() - daysToSubtract);
                let end = new Date(start);
                end.setDate(start.getDate() + 6);
                titleText = `Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ù‡Û•ÙØªØ§Ù†Û•: ${start.toLocaleDateString('ku-IQ')} ØªØ§ ${end.toLocaleDateString('ku-IQ')}`;
            } else if (state.report.period === 'monthly') {
                titleText = `Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û• Ø¨Û†: ${new Date(state.report.date).toLocaleDateString('ku-IQ', { year: 'numeric', month: 'long' })}`;
            }

            return `
            <div class="max-w-7xl mx-auto px-4 py-8">
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h1 class="text-3xl font-black text-white">ğŸ—„ï¸ Ù¾Ø§Ù†ÛÚµÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†</h1>
                    <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl transition shadow-md">Ø¯Û•Ø±Ú†ÙˆÙˆÙ†</button>
                </div>
                
                <div class="admin-card rounded-xl p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-3 text-yellow-500">Ú©Û†Ù†ØªØ±Û†ÚµÛŒ Ú•Ø§Ù¾Û†Ø±Øª</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-300">Ù…Ø§ÙˆÛ•ÛŒ Ú•Ø§Ù¾Û†Ø±Øª</label>
                            <select onchange="state.report.period = this.value; render()" class="input-field w-full rounded-xl px-4 py-3 bg-gray-700 text-white font-bold cursor-pointer">
                                <option value="daily" ${state.report.period === 'daily' ? 'selected' : ''}>Ú•Û†Ú˜Ø§Ù†Û•</option>
                                <option value="weekly" ${state.report.period === 'weekly' ? 'selected' : ''}>Ù‡Û•ÙØªØ§Ù†Û•</option>
                                <option value="monthly" ${state.report.period === 'monthly' ? 'selected' : ''}>Ù…Ø§Ù†Ú¯Ø§Ù†Û•</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold mb-2 text-gray-300">Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±ÙˆØ§Ø± ${state.report.period === 'monthly' ? '(Ù…Ø§Ù†Ú¯)' : ''}</label>
                            <input type="${state.report.period === 'monthly' ? 'month' : 'date'}" 
                                onchange="state.report.date = this.value; render()" 
                                value="${state.report.date}" 
                                class="input-field w-full rounded-xl px-4 py-3 bg-gray-700 text-white font-bold cursor-pointer text-center font-mono">
                        </div>
                    </div>

                    <button onclick="downloadExcel(getFilteredData(), 'Attendance_Report_${state.report.period}_${state.report.date.replace(/-/g, '')}')" class="w-full bg-green-500 hover:bg-green-600 text-white font-black py-3 rounded-xl transition duration-300 shadow-lg shadow-green-500/30 text-lg flex items-center justify-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª (Excel/CSV)
                        <span class="bg-white text-green-500 px-2 py-0.5 rounded-full text-xs font-black">${filteredData.length} ØªÛ†Ù…Ø§Ø±</span>
                    </button>
                </div>

                <div class="admin-card rounded-xl overflow-hidden shadow-lg">
                    <div class="p-4 bg-gray-700">
                        <h3 class="text-xl font-bold text-gray-100">${titleText}</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="report-table w-full text-right text-sm">
                            <thead>
                                <tr>
                                    <th class="w-12 text-center">#</th>
                                    <th>Ù†Ø§ÙˆÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</th>
                                    <th class="w-32">Ø¨Û•Ø±ÙˆØ§Ø±</th>
                                    <th class="w-28">Ú•Û†Ú˜</th>
                                    <th class="w-24 bg-green-900/50">Ú©Ø§ØªÛŒ Ù‡Ø§ØªÙ†</th>
                                    <th class="w-24 bg-red-900/50">Ú©Ø§ØªÛŒ Ú•Û†ÛŒØ´ØªÙ†</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredData.length === 0 
                                    ? `<tr><td colspan="6" class="text-center py-6 text-gray-400 font-bold">Ù‡ÛŒÚ† ØªÛ†Ù…Ø§Ø±ÛÚ© Ø¨Û† Ø¦Û•Ù… Ù…Ø§ÙˆÛ•ÛŒÛ• Ù†ÛŒÛŒÛ•.</td></tr>`
                                    : filteredData.map((item, index) => `
                                    <tr class="hover:bg-gray-700/50 transition duration-150">
                                        <td class="text-center text-gray-400">${index + 1}</td>
                                        <td class="font-bold text-white">${item.teacherName}</td>
                                        <td>${formatDateForDisplay(item.date)}</td>
                                        <td>${getKurdishDay(item.date)}</td>
                                        <td class="time-entry">${item.entryTime || 'Ù†Û•Ù‡Ø§ØªÙˆÙˆÛ•'}</td>
                                        <td class="time-exit">${item.exitTime || 'Ù†Û•Ú•Û†ÛŒØ´ØªÙˆÙˆÛ•'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }

        // --- Main Render Logic ---

        function render() {
            const app = document.getElementById('app');
            const nav = document.getElementById('navigation');
            
            document.body.classList.remove('admin-mode');
            if (state.currentView === 'admin') {
                document.body.classList.add('admin-mode');
            }

            // Navigation Rendering
            nav.innerHTML = `
                <div class="max-w-7xl mx-auto px-4">
                    <div class="flex gap-4 justify-center bg-white ${state.currentView === 'admin' ? 'admin-card' : 'shadow'} rounded-2xl p-2 transition-colors duration-300">
                        <button onclick="state.currentView='teacher'; render()" class="w-1/2 md:w-auto px-6 py-3 rounded-xl font-bold transition duration-200 ${state.currentView === 'teacher' ? 'bg-orange-500 text-white shadow-lg' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}">Ù…Ø§Ù…Û†Ø³ØªØ§ (ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†)</button>
                        ${state.isAdminAuthenticated 
                            ? `<button onclick="state.currentView='admin'; loadAttendanceData(); render()" class="w-1/2 md:w-auto px-6 py-3 rounded-xl font-bold transition duration-200 ${state.currentView === 'admin' ? 'bg-yellow-500 text-gray-900 shadow-lg' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}">Ø¦Û•Ø¯Ù…ÛŒÙ† (Ú•Ø§Ù¾Û†Ø±Øª)</button>`
                            : `<button onclick="state.currentView='admin'; render()" class="w-1/2 md:w-auto px-6 py-3 rounded-xl font-bold transition duration-200 ${state.currentView === 'admin' ? 'bg-red-500 text-white shadow-lg' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}">Ø¦Û•Ø¯Ù…ÛŒÙ† (Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•)</button>`
                        }
                    </div>
                </div>`;

            // Content Rendering
            let content = '';
            if (state.currentView === 'admin' && !state.isAdminAuthenticated) {
                content = renderAdminLogin();
            } else if (state.currentView === 'admin' && state.isAdminAuthenticated) {
                content = renderAdminView();
            } else {
                content = renderTeacherView();
            }
            app.innerHTML = content;
            
            if (state.currentView === 'teacher' && document.getElementById('teacherName')) {
                document.getElementById('teacherName').value = state.teacherName;
            }
        }

        // --- Initial Load & Setup ---
        
        function initializeApp() {
            // Setup initial structure in the body
            document.body.innerHTML = `
                <div id="navigation" class="fixed top-0 left-0 right-0 z-50 p-4 pt-6 bg-transparent"></div>
                <div id="app" class="w-full"></div>
                <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-900/80 z-[9999] flex flex-col items-center justify-center opacity-0 transition-opacity duration-300">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent mb-4"></div>
                    <p id="loadingText" class="text-white font-bold">Ø¯Ø§ØªØ§Ú©Ø§Ù† Ø¨Ø§Ø± Ø¯Û•Ú©Ø±ÛÙ†...</p>
                </div>
            `;
            
            // Start the application logic
            render(); 
            loadAttendanceData(); 
        }

        // Start everything when the page is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
